══════════════════════════════════════════════
KOBOLDOS — CHANGELOG
══════════════════════════════════════════════

VERSION 0.3.5 ALPHA (2026-02-27)
─────────────────────────────────
Prozess-Entlastung (Schwere Operationen ausgelagert):
• PlaywrightTool: Von synchronem waitUntilExit auf AsyncProcess.run umgestellt
  — blockiert den Agent Loop nicht mehr (war kritischer Bug!)
• STTManager: Whisper-Inference via Task.detached vom MainActor geloest
  — UI friert nicht mehr bei Sprachtranskription ein
• VisionTool: OCR (VNImageRequestHandler) in Task.detached verschoben
  — grosse Bilder blockieren den Agent nicht mehr
• Analyse: Alle 50+ Tools auf Blocking-Verhalten geprueft
  — ShellTool, AppleScriptTool, Network-Tools waren bereits async-safe

Lokale Bildgenerierung (ComfyUI + SDXL):
• ComfyUI Integration: Lokale Bildgenerierung via ComfyUI API (Port 8188)
• 4 Modelle: Juggernaut XL v9, SDXL Base 1.0, SDXL Refiner, 4x-UltraSharp
• Image-Generation-Skill: Automatischer Server-Start + Workflow + Polling
• kobold_generate.py: CLI-Helper fuer direkte Bildgenerierung
• Output: Bilder landen in ~/Documents/KoboldOS/Bilder/
• Bilder werden automatisch im Chat UND per Telegram gezeigt

Telegram Bot — JSON-Leak Fix:
• Root Cause: Lokale Modelle gaben kaputtes JSON aus, JSONSerialization scheiterte
• Loesung: Regex-basierte Text-Extraktion statt JSON-Parsing
• 3-Schicht-Fallback: DaemonListener + TelegramBot + Leere-Antwort-Guard
• Ergebnis: Keine rohen JSON-Strings mehr an Telegram-Nutzer

Workflow-Ansicht (Alle Tools, Verbindungen & Skills):
• 46 Tools verfuegbar: Tool-Auswahl von 16 auf 46 erweitert, 9 Kategorien
  — Basis, Kommunikation, APIs & Verbindungen, Medien, Gedaechtnis,
    macOS, IoT/Infra, System, Agenten
• Suchfeld: Schnelles Finden von Tools per Name oder Label
• Skill-Injection: Agent-Nodes koennen Faehigkeiten zugewiesen bekommen
  — Skill-Inhalt wird automatisch in den Prompt injiziert
• Speichern-Button: Expliziter Save mit visuellem Feedback
• Neue Persistenz: Workflows unter ~/Documents/KoboldOS/workflows/
  — sichtbar, exportierbar, Auto-Migration aus App Support

Bildgenerierung — Spam-Fix:
• ShellTool Timeout: Hard-Cap von 60s auf 300s erhoeht
• Lock-Datei: kobold_generate.py nutzt .generating.lock
• Queue-Check: Prueft ComfyUI Queue vor Submit
• Exit Code 2: Dedizierter Code wenn bereits Generierung laeuft

Skills-System:
• image_generation Skill automatisch aktiviert bei Neuinstallation
• SkillLoader: image_generation in Default-Enabled-Liste aufgenommen
• ~53.000+ Lines of Code

VERSION 0.3.4 ALPHA (2026-02-27)
─────────────────────────────────
Telegram Bot — Sprachnachrichten:
• Voice Messages via Telegram Bot: OGG Download → ffmpeg → whisper.cpp STT
• Audio-Nachrichten (MP3 etc.) werden ebenfalls transkribiert
• Transkription wird als Bestaetigung zurueckgesendet, dann Agent-Antwort
• Falls kein Whisper-Modell geladen: klare Fehlermeldung an User
• STTManager Race-Condition gefixt: loadModelIfAvailable() vor Zugriff

ToolCallParser — Robuster gegen LLM-Fehler:
• Neue Strategy 6: Regex-Recovery fuer komplett kaputtes JSON
  (z.B. fehlende [] bei thoughts — toolargs Sub-Objekt wird direkt extrahiert)
• Parser erkennt BEIDE Varianten: tool_name + toolname, tool_args + toolargs
• extractEmbeddedToolCall() in AgentLoop ebenfalls erweitert
• Sicherheitsnetz in TelegramBot: cleanJSONResponse() mit Balanced-Brace Fallback

GUI Performance:
• topics/activeTopicId: objectWillChange nur bei echtem Wert-Wechsel
• OnboardingView: 6 repeatForever Animationen auf 2 reduziert
• Weniger unnoetige Re-Renders im Idle

Settings UI:
• Tab-Reihenfolge neu: Allgemein > Agenten > Benachrichtigungen > ... > Ueber
• Persoenlichkeit in Agenten-Tab integriert (kein eigener Tab mehr)
• DaemonLogView: Vollbild-Modus mit Filter, Clear-Button, Escape-Shortcut
• Suno AI Verbindungskarte nach oben verschoben (neben Telegram)

Dokumentation:
• TUTORIAL.txt: Umfassendes 14-Kapitel Benutzerhandbuch fuer DMG
• CHANGELOG.txt und README.md aktualisiert
• ~52.200+ Lines of Code

VERSION 0.3.3 ALPHA (2026-02-27)
─────────────────────────────────
File-Upload fuer YouTube, SoundCloud & Telegram:
• YouTube Resumable Upload (2-Phasen: Metadata POST → Binary PUT), 600s Timeout
• SoundCloud Upload: Multipart mit track[asset_data], Titel/Genre/Tags, 500MB Limit
• Telegram File-Sending: send_file, send_photo, send_audio via Multipart, 50MB Limit
• Google Drive Upload: Multipart/related (JSON Metadata + Binary)
• MIME-Type-Erkennung fuer 30+ Formate (Video, Audio, Dokumente, Archive, Code)

Neue Verbindungen:
• Suno AI (Musik-Generierung): generate/status/get_track/list_tracks, sunoapi.org
• Reddit OAuth: search/hot/new/read_post/comment, permanente Tokens
• OAuthTokenHelper: Generischer Token-Refresh fuer alle OAuth-Services

OAuth Token Refresh & 401-Detection:
• Microsoft + Uber: Automatischer Token-Refresh
• GitHub/Slack/Notion/WhatsApp: 401-Detection mit "Bitte neu anmelden" Meldung
• Connection Verification: Echte Token-Pruefung via API-Call (statt gespeicherter Bool)

Tool-Call Recovery (Agent-Stabilitaet):
• extractEmbeddedToolCall() findet Tool-Calls in Response-Text eingebettet
• String-aware Brace-Parsing in ToolCallParser (Braces in Strings ignoriert)
• Recovery in beiden Paths: runStreaming + runInner

Telegram Bot Fix:
• Doppel-Nachricht verhindert: Agent nutzt jetzt response-Tool statt telegram_send
• telegram_send nur noch fuer Dateien/Fotos/Audio und proaktive Benachrichtigungen

Task-Chat-System:
• Eigene Chats pro Task mit isoliertem Kontext
• Sidebar-Sektion "Task-Chats" mit Checklist-Icon
• Cron-Tasks via NotificationCenter statt handleAgent() direkt

Weitere Fixes:
• FileTool: Zugriff auf gesamtes Home-Verzeichnis + /tmp (Blocklist fuer Secrets)
• Google OAuth: Credential-Eingabefelder in Verbindungen
• SoundCloud OAuth Token-Mismatch behoben
• iMessage-Integration entfernt (Telegram ist stabil)
• UNUserNotificationCenter ersetzt deprecated NSUserNotification
• ~51.840 Lines of Code

VERSION 0.3.2 UPDATE (2026-02-27)
─────────────────────────────────
Performance (Freeze-Fixes):
• isNewest O(n)-Scan eliminiert — einmalig vor ForEach berechnet
• SkillLoader In-Memory-Cache (60s TTL) — spart 22+ Disk-Reads/Message
• async let: smartMemoryRetrieval + relevantSkills parallel statt sequentiell
• repeatForever Animation auf Streaming-Bubble entfernt (60fps CADisplayLink)
• Date() in Loading-Bubble durch statischen Placeholder ersetzt
• Markdown NSCache — AttributedString wird nur einmal geparsed
• GlobalHeaderBar: DateFormatter gecacht, 60s Timer statt Random-Rerenders

UI-Verbesserungen:
• Lange Antworten (>800 Zeichen) eingeklappt mit "Mehr/Weniger anzeigen"
• Copy/TTS Buttons immer sichtbar (nicht hover-only)
• Clear-Button setzt Session-Titel/Zeit in Sidebar zurueck
• Agent bettet Quellen-URLs als Markdown-Links ein

Bekannt: Heavy-Load Lags bei zweiter Nachricht + View-Wechsel (CPU 100%)
• ~49.553 Lines of Code

VERSION 0.3.2 ALPHA (2026-02-27)
─────────────────────────────────
• Settings Overhaul: Tabs reorganisiert, Beschreibungen, Provider entfernt
• Berechtigungen: Persistent defaults, Autonomie-Level Fix, Agent fragt nicht mehr
• Freeze-Fixes: Timer-Guards, Timeout, isAgentLoadingInCurrentChat
• Context-Bar: Persistent pro Chat, formatierte Token-Anzeige, Komprimieren-Button
• TTS-Speaker an jeder Assistant-Nachricht
• Ollama + Embedding Status bei Start prüfen
• Telegram-Bot: Persistente History
• Skills-Suche: Relevante Skills per Query im System-Prompt
• Aufgeräumt: docker, linux, MCP, MenuBar, ImageGen, LlamaService entfernt
• ~50.185 Lines of Code

VERSION 0.2.8 ALPHA (2026-02-23)
─────────────────────────────────
• Teams: Echtes 3-Runden-Diskursmodell (Analyse → Diskussion → Synthese)
• Teams: Persistenz, Organigramm mit Zielen, Chat-Controls
• PlaywrightTool: Chrome-Automatisierung (navigate, click, fill, screenshot)
• ScreenControlTool: Maus/Tastatur/Screenshot/OCR (CGEvent, Vision.framework)
• Goals-System: Ziele unter Persoenlichkeit, fliessen in System-Prompt
• Idle Tasks: User-definierbare Aufgaben (konkret + vage Richtungen)
• Heartbeat: Konfigurierbar mit Quiet Hours und Rate-Limiting
• Task/Workflow Team-Integration (teamId, Team-Picker, Team-Node)
• Live Thinking Layers: Steps/Tools + Thinking-Status + Typing (nicht ueberlappend)
• Chat-Eingabe: Doppelte Hoehe, groessere Schrift
• Schriftgroesse wirkt auf User + Assistant Nachrichten
• Temperatur: Dashboard zeigt °C statt Kuehlt/Normal/Hoch
• Interactive Buttons: Strikte Ja/Nein-Erkennung (weniger Spam)
• SD Crash Fix: Model-Loading auf Background-Thread
• SD Modell-Auswahl aus Ordner
• Settings: Benachrichtigungen-Sektion, Debugging & Sicherheit-Sektion
• AI-Vorschlaege via SuggestionService (Ollama, 4h-Cache)
• Nachrichten-Queue statt Agent-Interrupt
• 44.572 Lines of Code

VERSION 0.2.5 ALPHA (2026-02-22)
─────────────────────────────────
• TTS: Agent kann Text vorlesen (speak-Tool, AVSpeechSynthesizer)
• STT: Lokale Spracherkennung via whisper.cpp (SwiftWhisper)
• Stable Diffusion: Lokale Bildgenerierung (generate_image Tool)
• Medien-Embedding: Bilder/Audio/Video automatisch inline im Chat
• ToolCallParser: 5 Parsing-Strategien für robuste Tool-Erkennung
• Verbindungen: Echte Brand-Logos, WebApp + Tunnel nebeneinander
• A2A unter Verbindungen integriert, Proaktiv in Gedächtnis
• Dashboard: Willkommensgruß + tägliche Sprüche
• Freeze-Fix: UpdateManager blockierte MainThread (Deadlock)
• Leerer Chat: Wechselnde Beispiele für echte KoboldOS-Features
• "Skills" → "Fähigkeiten" umbenannt

VERSION 0.2.0 ALPHA (2026-02-22)
──────────────────────────────────────────────

NEU: INTERAKTIVE CLI
  - `kobold` ohne Subcommand startet interaktive Chat-Session
  - Farbige Terminal-Ausgabe (Thinking, Tools, Antworten)
  - SSE-Streaming mit Echtzeit-Anzeige
  - Session-Persistenz unter ~/Library/Application Support/KoboldOS/
  - 12 Slash-Befehle (/help, /new, /list, /load, /model, etc.)
  - Auto-Daemon: startet automatisch wenn nicht erreichbar
  - Session-Export als Markdown

NEU: VOLLSTAENDIGE CLI-BEFEHLE
  - kobold health       — Server-Status mit Exit-Code
  - kobold memory       — Core Memory verwalten (list/get/set/delete/snapshot)
  - kobold task         — Aufgaben verwalten (list/create/delete/toggle)
  - kobold workflow     — Workflows verwalten und ausfuehren
  - kobold history      — Chat-Verlauf loeschen
  - kobold skill        — Markdown-Skills importieren/verwalten
  - kobold secret       — Keychain-Secrets verwalten (verdeckte Eingabe)
  - kobold config       — UserDefaults-Konfiguration
  - kobold checkpoint   — Checkpoints verwalten/fortsetzen
  - kobold card         — A2A Agent Card anzeigen/entdecken

NEU: CONFIDENCE SELF-ASSESSMENT
  - Agent bewertet jede Antwort mit Konfidenz (0.0-1.0)
  - Farbkodierung: gruen (>0.8), gelb (0.5-0.8), rot (<0.5)
  - Bei niedriger Konfidenz fragt Agent nach statt zu raten
  - Confidence-Badge in GUI und CLI

NEU: CHECKPOINT/RESUME
  - Agent-State wird an Tool-Boundaries gespeichert
  - Lange Tasks koennen pausiert und fortgesetzt werden
  - Ctrl+C waehrend Stream speichert automatisch Checkpoint
  - `kobold checkpoint resume <id>` zum Fortsetzen
  - REST API: GET/POST/DELETE /checkpoints

NEU: A2A AGENT CARDS
  - /.well-known/agent.json Endpoint (Google A2A Standard)
  - Oeffentlich zugaenglich (kein Auth noetig)
  - Beschreibt Faehigkeiten, Endpoints, Tools, Agent-Typen
  - `kobold card discover <url>` zum Entdecken anderer Agents

NEU: MEMORY PAGING (ARCHIVAL MEMORY)
  - Automatische Archivierung bei >80% Block-Auslastung
  - Aelteste 50% werden in ArchivalMemoryStore verschoben
  - Agent kann mit archival_memory_search alte Infos suchen
  - archival_memory_insert zum manuellen Archivieren
  - Archiv-Ansicht in GUI MemoryView

NEU: MEMORY VERSIONIERUNG
  - Git-style Versioning fuer Core Memory
  - Automatischer Commit nach jeder Session
  - SHA-256 Content-Hashing (keine Duplikate)
  - kobold memory log — Versionshistorie
  - kobold memory diff <id1> <id2> — Aenderungen vergleichen
  - kobold memory rollback <id> — Zuruecksetzen
  - Versions-Tab in GUI MemoryView

INFRASTRUKTUR
  - Gemeinsamer DaemonClient fuer alle CLI-Befehle
  - ANSI Terminal-Formatter mit isatty() Erkennung
  - SSE Stream Parser fuer Agent-Events
  - Session-Manager mit Debounced-Save

STATISTIK
  - 22.821 Lines of Code (Swift)
  - 78 Tests (alle bestanden)
  - 16 CLI-Befehle
  - 12 Slash-Commands
  - 7 neue REST-Endpoints

──────────────────────────────────────────────

VERSION 0.1.9 (2026-02-21)
──────────────────────────────────────────────
  - Multi-Session Support (GUI)
  - Onboarding Wizard mit Persona-Auswahl
  - 15 Sprachen (Lokalisierung)
  - SecretStore (Keychain)
  - BackupManager
  - SkillLoader (Markdown Skills)
  - LaunchAgent Auto-Start
  - Settings: 12 Sektionen
  - 20.037 LOC, 78 Tests

VERSION 0.1.6 (2026-02-20)
──────────────────────────────────────────────
  - SSE Streaming fuer Agent-Antworten
  - Agent Tools (Shell, File, HTTP, AppleScript, Notify)
  - ToolCallParser mit Multi-Format Support
  - ToolRuleEngine pro Agent-Typ
  - DelegateTaskTool (Sub-Agent Spawning)
  - Safe Mode mit Crash Recovery
  - Trace-System fuer Debugging

VERSION 0.1.5 (2026-02-19)
──────────────────────────────────────────────
  - Core Memory (Letta-style, labeled blocks)
  - Plugin System (CalculatorPlugin)
  - MemoryStore (Vector-basiert)
  - Agent Message Bus
  - Multi-Agent Support (5 Typen)

VERSION 0.1.4 (2026-02-18)
──────────────────────────────────────────────
  - SwiftUI GUI (Dark Theme, Glass Design)
  - Dashboard, Chat, Models, Metrics Views
  - RuntimeManager mit Health-Monitoring
  - DMG Distribution

VERSION 0.1.3 (2026-02-17)
──────────────────────────────────────────────
  - Erste CLI-Version
  - Daemon mit HTTP Server
  - Ollama Integration
  - Grundlegende Chat-Funktion

══════════════════════════════════════════════